name: Quality Gate

on:
  push:
  pull_request:

jobs:
  quality-gate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Verify data exists
        run: test -f data/players.json

      - name: Generate site
        run: node scripts/generate-all.mjs

      - name: Ensure repo is clean after generation
        run: |
          git status --porcelain

          # git status --porcelain=v1 lines look like:
          # " M path" or "M  path" or "?? path"
          # => always TWO status chars, then a space, then the path
          ALLOWED_REGEX='^.. (index\.html|players/index\.html|sitemap\.xml|feed\.xml)$|^.. (about|learn|privacy|terms|tools|glossary|positions|teams|competitions|legacy|fantasy|embed|sports)/index\.html$|^.. players/[^/]+/index\.html$|^.. (learn|positions|teams|competitions|legacy|embed)/[^/]+/index\.html$|^.. players/\.generated\.txt$'

          DIRTY="$(git status --porcelain | grep -Ev "$ALLOWED_REGEX" || true)"

          if [ -n "$DIRTY" ]; then
            echo "Unexpected dirty files after generation:"
            echo "$DIRTY"
            exit 1
          fi

      - name: Run quality gate
        run: node scripts/quality-gate.mjs
