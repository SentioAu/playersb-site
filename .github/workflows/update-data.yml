name: Update PlayersB Data (Mode 1)

on:
  workflow_dispatch: {}
  schedule:
    - cron: "0 */6 * * *"
  push:
    branches: [ "main" ]
    paths:
      - "data/**"
      - "templates/**"
      - "scripts/**"
      - "_redirects"
      - "compare.html"
      - "contact.html"
      - "robots.txt"
      - ".github/workflows/update-data.yml"

permissions:
  contents: write

concurrency:
  group: update-data-main
  cancel-in-progress: true

jobs:
  regenerate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # ✅ Only install if package.json exists (your repo may not need deps)
      - name: Install dependencies (optional)
        run: |
          if [ -f package.json ]; then
            echo "package.json found — installing dependencies"
            if [ -f package-lock.json ]; then
              npm ci
            elif [ -f pnpm-lock.yaml ]; then
              npm i -g pnpm
              pnpm i --frozen-lockfile
            elif [ -f yarn.lock ]; then
              corepack enable
              yarn install --frozen-lockfile
            else
              npm i
            fi
          else
            echo "No package.json — skipping dependency install"
          fi

      - name: Resolve Football-Data token (supports 2 secret names)
        env:
          FOOTBALL_DATA_API_TOKEN_PRIMARY: ${{ secrets.FOOTBALL_DATA_API_TOKEN }}
          FOOTBALL_DATA_TOKEN_FALLBACK: ${{ secrets.FOOTBALL_DATA_TOKEN }}
        run: |
          TOKEN_SOURCE=""
          TOKEN="${FOOTBALL_DATA_API_TOKEN_PRIMARY}"
          if [ -n "${TOKEN}" ]; then
            TOKEN_SOURCE="FOOTBALL_DATA_API_TOKEN"
          fi

          if [ -z "${TOKEN}" ]; then
            TOKEN="${FOOTBALL_DATA_TOKEN_FALLBACK}"
            if [ -n "${TOKEN}" ]; then
              TOKEN_SOURCE="FOOTBALL_DATA_TOKEN"
            fi
          fi

          if [ -z "${TOKEN}" ]; then
            echo "Missing repository secret. Set FOOTBALL_DATA_API_TOKEN (preferred) or FOOTBALL_DATA_TOKEN in Settings -> Secrets and variables -> Actions."
            exit 1
          fi

          echo "::add-mask::${TOKEN}"
          echo "FOOTBALL_DATA_API_TOKEN=${TOKEN}" >> "$GITHUB_ENV"
          echo "Football-Data token resolved successfully."
          echo "Token source: ${TOKEN_SOURCE}"
          echo "Token length: ${#TOKEN}"

      - name: Fetch and generate site (core + players + sitemap) and run quality gate
        env:
          REQUIRE_FOOTBALL_DATA_TOKEN: "1"
        run: |
          node scripts/fetch-football-data.mjs

          node -e "const fs=require('fs'); const f=JSON.parse(fs.readFileSync('data/fixtures.json','utf8')); const s=JSON.parse(fs.readFileSync('data/standings.json','utf8')); if(!Array.isArray(f.competitions)||f.competitions.length===0){console.error('sanity check failed: fixtures competitions are empty'); process.exit(1);} if(!Array.isArray(s.competitions)||s.competitions.length===0){console.error('sanity check failed: standings competitions are empty'); process.exit(1);} console.log('sanity check passed: fixtures and standings contain competitions');"

          node scripts/fetch-archive.mjs
          node scripts/fetch-players.mjs --dry-run || echo "fetch-players dry-run failed; continuing with existing players source"
          node scripts/fetch-players.mjs || echo "fetch-players failed; continuing with existing players.json"
          node scripts/sync-players-from-fantasy.mjs
          node scripts/generate-all.mjs

      - name: Notify pipeline failure webhook (optional)
        if: ${{ failure() }}
        env:
          ALERT_WEBHOOK_URL: ${{ secrets.ALERT_WEBHOOK_URL }}
        run: |
          if [ -z "${ALERT_WEBHOOK_URL}" ]; then
            echo "No ALERT_WEBHOOK_URL configured; skipping failure webhook."
            exit 0
          fi

          PAYLOAD=$(cat <<JSON
          {
            "text": "PlayersB update-data workflow failed on branch ${{ github.ref_name }}. Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          }
          JSON
          )

          curl -sS -X POST -H "Content-Type: application/json" -d "$PAYLOAD" "$ALERT_WEBHOOK_URL" && echo "Failure webhook sent."

      - name: Commit generated files (if changed)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if git status --porcelain | grep .; then
            git add -A
            git commit -m "chore: regenerate site outputs"
            git push
          else
            echo "No changes to commit."
          fi
